name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  unit-tests:
    strategy:
      matrix:
        python: [ "3.8", "3.9" ]
    runs-on: "ubuntu-latest"

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pylint
        run: | 
          pylint --fail-under 7 app
          exitcode="$?"
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          exit "$exitcode"

      - name: Run unit tests
        run: |
          python -m unittest

  bdd-tests:
    strategy:
      matrix:
        python: [ "3.8", "3.9" ]
    runs-on: "ubuntu-latest"

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run BDD tests
        run: |
          cd bdd-tests
          behave
          cd ..

  integration-tests:
    strategy:
      matrix:
        python: [ "3.8", "3.9" ]
    runs-on: "ubuntu-latest"

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install docker-compose -y

      - name: Start LocalStack with Docker Compose
        run: docker-compose up -d  # Spin up containers in the background

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run integration tests
        run: |
          pytest --maxfail=1 --disable-warnings -v --alluredir=./allure-results
          coverage run -m pytest && coverage report -m

      - name: Teardown Docker
        if: always()
        run: docker-compose down
    
      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()   # ← runs even if tests failed
        with:
          allure_results: allure-results

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report

  sast:
    needs: [unit-tests, bdd-tests, integration-tests]
    runs-on: "ubuntu-latest"

    permissions:
      contents: read
      security-events: write  # ← required for uploading SARIF results
    
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit security scan
        run: |
          bandit -r app -f json -o bandit-report.json || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

# name: CI
# on:
#   push:
#     branches: [main]
#   pull_request:
#     branches: [main]
# jobs:
#   unit-tests:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v3
#       - uses: actions/setup-python@v4
#         with:
#           python-version: "3.9"
#       - run: pip install --upgrade pip && pip install -r requirements.txt
#       - name: Run pylint
#         run: |
#           pylint --fail-under 7 app
#           exitcode="$?"
#           echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
#           exit "$exitcode"
#       - run: python -m unittest
#   sast:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read
#       security-events: write
#     steps:
#       - uses: actions/checkout@v3
#       - uses: actions/setup-python@v4
#         with:
#           python-version: "3.9"
#       - run: pip install --upgrade pip && pip install bandit
#       - run: bandit -r app -f sarif -o bandit-results.sarif || true
#       - uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: bandit-results.sarif
#       - uses: actions/upload-artifact@v4
#         if: always()
#         with:
#           name: bandit-report
#           path: bandit-results.sarif
